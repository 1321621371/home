<mxfile host="app.diagrams.net" modified="2022-12-15T07:27:02.754Z" agent="5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36 Edg/108.0.1462.42" etag="7jxdwuE71XN6nrCWmXtv" version="20.7.2" type="github">
  <diagram name="Page-1" id="9f46799a-70d6-7492-0946-bef42562c5a5">
    <mxGraphModel dx="2491" dy="788" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1100" pageHeight="850" background="none" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="78961159f06e98e8-17" value="system-user.dtsi" style="swimlane;html=1;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=none;fontFamily=Verdana;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="60" y="30" width="190" height="227" as="geometry" />
        </mxCell>
        <mxCell id="78961159f06e98e8-21" value="&lt;div&gt;backlight {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;			&lt;/span&gt;compatible = &quot;pwm-backlight&quot;;&lt;/div&gt;&lt;div&gt;brightness-levels = &amp;lt;.....&amp;gt;;&lt;br&gt;&lt;/div&gt;&lt;div&gt;default-brightness-level = &amp;lt;255&amp;gt;;&lt;br&gt;&lt;/div&gt;&lt;div&gt;pwms = &amp;lt;&amp;amp;PWM_0 0 5000000&amp;gt;; /&lt;br&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="78961159f06e98e8-17" vertex="1">
          <mxGeometry y="26" width="190" height="124" as="geometry" />
        </mxCell>
        <mxCell id="78961159f06e98e8-20" value="+ method(type): type" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;whiteSpace=wrap;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" parent="78961159f06e98e8-17" vertex="1">
          <mxGeometry y="150" width="190" height="6" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-89" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="78961159f06e98e8-30" target="pFG0BNeJu_NjUhtNRgoJ-75">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="78961159f06e98e8-30" value="&lt;p class=&quot;MsoNormal&quot;&gt;drivers/video/backlight/pwm_bl.c&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;static const&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;struct of_device_id&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp;pwm_backlight_of_match[] = {&lt;/span&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span&gt;	&lt;/span&gt;&lt;span&gt;{ &lt;/span&gt;&lt;span style=&quot;font-family: Calibri; font-size: 10.5pt;&quot;&gt;.compatible = &quot;pwm-backlight&quot;&lt;/span&gt;&lt;span&gt;&amp;nbsp;},&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span&gt;	&lt;/span&gt;&lt;span&gt;{ }&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;};&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;br&gt;&lt;p class=&quot;MsoNormal&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;" style="swimlane;html=1;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=47;horizontalStack=0;resizeParent=1;resizeLast=0;collapsible=1;marginBottom=0;swimlaneFillColor=#ffffff;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=none;fontFamily=Verdana;fontSize=12" parent="1" vertex="1">
          <mxGeometry x="310" y="30" width="240" height="221" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-2" value="" style="endArrow=classic;html=1;rounded=0;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="250" y="140" as="sourcePoint" />
            <mxPoint x="310" y="140" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-23" value="static int pwm_backlight_parse_dt(struct device *dev," style="swimlane;fontStyle=1;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;" vertex="1" parent="1">
          <mxGeometry x="610" y="30" width="460" height="90" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-24" value="ret = of_property_read_u32_array(node, &quot;brightness-levels&quot;,&#xa;						 data-&gt;levels,data-&gt;max_brightness);  //解析设备树背光等级&#xa;ret = of_property_read_u32(node, &quot;default-brightness-level&quot;,&amp;value);//默认背光等级&#xa;		data-&gt;dft_brightness = value;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-23">
          <mxGeometry y="26" width="460" height="64" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-27" value="int pwm_backlight_brightness_default(struct device *dev," style="swimlane;fontStyle=1;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;" vertex="1" parent="1">
          <mxGeometry x="610" y="150" width="470" height="100" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-28" value="为 PWM 值创建默认校正表以创建线性亮度 使用 CIE1931 算法的基于 LED 的背光。&#xa;retval = cie1931((i * PWM_LUMINANCE_SCALE) /&#xa;				 data-&gt;max_brightness) * period;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-27">
          <mxGeometry y="26" width="470" height="74" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-41" value="struct backlight_device *backlight_device_register(const char *name," style="swimlane;fontStyle=1;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;movable=1;resizable=1;rotatable=1;deletable=1;editable=1;connectable=1;" vertex="1" parent="1">
          <mxGeometry x="630" y="260" width="660" height="470" as="geometry">
            <mxRectangle x="610" y="330" width="410" height="70" as="alternateBounds" />
          </mxGeometry>
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-42" value="backlight_device_register是backlight class提供的接口函数，&#xa;将设备注册到backlight class上，属性文件向文件系统注册，&#xa;读写操作的实现均在backlight中实现，&#xa;最终的gpio和pwm控制通过在pwm_backlight_ops中设置的回调实现。&#xa;&#xa;// 使用backlight class接口注册设备&#xa;new_bd-&gt;dev.class = backlight_class;&#xa;	new_bd-&gt;dev.parent = parent;&#xa;	new_bd-&gt;dev.release = bl_device_release;&#xa;//设备节点关联 /sys/class/backlight/XXX&#xa;	dev_set_name(&amp;new_bd-&gt;dev, &quot;%s&quot;, name);&#xa;	dev_set_drvdata(&amp;new_bd-&gt;dev, devdata);&#xa;&#xa;	// 将此设备注册到系统里面，里面会创建 backlight_class 预设的那几个设备节点&#xa;	rc = device_register(&amp;new_bd-&gt;dev);&#xa;&#xa;	// 注册监听 frambuffer 的事件通知链&#xa;	rc = backlight_register_fb(new_bd);&#xa;	// 指定背光控制接口&#xa;	new_bd-&gt;ops = ops;&#xa;	// 将此设备加入到链表内, 便于外部查询获取&#xa;	mutex_lock(&amp;backlight_dev_list_mutex);&#xa;	list_add(&amp;new_bd-&gt;entry, &amp;backlight_dev_list);&#xa;	mutex_unlock(&amp;backlight_dev_list_mutex);&#xa;	// 发出事件通知, 有新的背光设备被注册到系统中&#xa;	blocking_notifier_call_chain(&amp;backlight_notifier, BACKLIGHT_REGISTERED, new_bd);&#xa;&#xa;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=13;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-41">
          <mxGeometry y="26" width="660" height="444" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-75" value="drivers/video/backlight/pwm_bl.c&#xa;" style="swimlane;fontStyle=1;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;" vertex="1" parent="1">
          <mxGeometry x="20" y="320" width="520" height="340" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-76" value="static int pwm_backlight_probe(struct platform_device *pdev){............." style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-75">
          <mxGeometry y="26" width="520" height="26" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-77" value="ret = pwm_backlight_parse_dt(&amp;pdev-&gt;dev, &amp;defdata);" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-75">
          <mxGeometry y="52" width="520" height="26" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-78" value="// 申请一块内存用于保存pwm_bl_data数据&#xa;pb = devm_kzalloc(&amp;pdev-&gt;dev, sizeof(*pb), GFP_KERNEL);" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-75">
          <mxGeometry y="78" width="520" height="52" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-82" value="ret = pwm_backlight_brightness_default(&amp;pdev-&gt;dev, data,state.period);" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-75">
          <mxGeometry y="130" width="520" height="26" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-84" value="bl = backlight_device_register(dev_name(&amp;pdev-&gt;dev), &amp;pdev-&gt;dev, pb,&#xa;       &amp;pwm_backlight_ops, &amp;props);&#xa;// dev_name(&amp;pdev-&gt;dev)：背光设备名称&#xa;// &amp;pdev-&gt;dev：父设备       pb：私有数据&#xa;// pwm_backlight_ops:背光控制调节的回调		props:默认的背光属性" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-75">
          <mxGeometry y="156" width="520" height="84" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-85" value="bl-&gt;props.power = pwm_backlight_initial_power_state(pb);&#xa;backlight_update_status(bl);  //更新背光信息&#xa;&#xa;&#xa;" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-75">
          <mxGeometry y="240" width="520" height="50" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-81" value="&#xa;...............................}" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-75">
          <mxGeometry y="290" width="520" height="50" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-86" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="pFG0BNeJu_NjUhtNRgoJ-77" target="pFG0BNeJu_NjUhtNRgoJ-24">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-91" value="static const struct backlight_ops pwm_backlight_ops = {" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;fontSize=13;" vertex="1" parent="1">
          <mxGeometry x="20" y="710" width="410" height="104" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-92" value=".update_status	= pwm_backlight_update_status,  //背光占空比的更新" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=13;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-91">
          <mxGeometry y="26" width="410" height="26" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-93" value=".check_fb	= pwm_backlight_check_fb," style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=13;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-91">
          <mxGeometry y="52" width="410" height="26" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-94" value="}；" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=13;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-91">
          <mxGeometry y="78" width="410" height="26" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-98" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=13;" edge="1" parent="1" source="pFG0BNeJu_NjUhtNRgoJ-84" target="pFG0BNeJu_NjUhtNRgoJ-91">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="20" y="503" />
              <mxPoint y="503" />
              <mxPoint y="680" />
              <mxPoint x="225" y="680" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-100" value="static int pwm_backlight_update_status(struct backlight_device *bl)" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=26;fillColor=none;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;fontSize=13;" vertex="1" parent="1">
          <mxGeometry x="600" y="760" width="460" height="80" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-103" value="state.duty_cycle = compute_duty_cycle(pb, brightness); //计算占空比&#xa;		pwm_apply_state(pb-&gt;pwm, &amp;state);&#xa;		pwm_backlight_power_on(pb);  // // 打开背光" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=13;" vertex="1" parent="pFG0BNeJu_NjUhtNRgoJ-100">
          <mxGeometry y="26" width="460" height="54" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-108" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.325;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=13;" edge="1" parent="1" source="pFG0BNeJu_NjUhtNRgoJ-82" target="pFG0BNeJu_NjUhtNRgoJ-28">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="590" y="463" />
              <mxPoint x="590" y="200" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-109" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=13;" edge="1" parent="1" source="pFG0BNeJu_NjUhtNRgoJ-84" target="pFG0BNeJu_NjUhtNRgoJ-42">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pFG0BNeJu_NjUhtNRgoJ-110" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.457;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;fontSize=13;" edge="1" parent="1" source="pFG0BNeJu_NjUhtNRgoJ-92" target="pFG0BNeJu_NjUhtNRgoJ-100">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
